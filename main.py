from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
    ConversationHandler
)

# Состояния
CHOOSE_TYPE, ASK_QUESTION = range(2)

# Вопросы для каждого типа личности
PERSONALITY_TESTS = {
    1: [
        "  ''Большинство людей видит во мне серьезного и делового человека: «Сказано - сделано». Я думаю, это так.''",
        "  ''Я всегда старался быть честным и объективным с собой, и я полон решимости любой ценой следовать тому, что говорит мне моя совесть''",
        "  ''Несмотря на то что я, конечно, могу быть сумасбродным, это, в общем, не мой стиль.''",
        "  ''Кажется, что я живу с судьей в моей голове: иногда этот судья мудрый и проницательный, но часто он жесткий и суровый.''",
        "  ''Я чувствую, что заплатил большую цену, стараясь быть идеальным.''",
        "  ''Я люблю смеяться так же часто, как и другие, - мне следовало бы делать это чаще!''",
        "  ''Мои принципы и идеалы вдохновляют меня на еще более великие достижения и делают мою жизнь еще более значимой.''",
        "  ''Я не понимаю, почему у такого большого количества людей такие низкие стандарты.''",
        "  ''От меня так сильно зависит выполнение многих вещей, что мне надо быть более организованным и методичным, чем окружающие.''",
        "  ''У меня есть ощущение, что мне необходимо выполнить личную миссию, - может быть, это высшее призвание.Я думаю, что в течение моей жизни я смогу совершить что-то исключительное.''",
        "  ''Я ненавижу ошибки, поэтому чрезвычайно стараюсь для того, чтобы все было сделано правильно.''",
        "  ''Большую часть жизни я верил в то, что «правильное - это правильное, а неправильное — это неправильное», и этим все сказано.''",
        "  ''Мне тяжело принять фразу: «Уже сделано достаточно хорошо».''",
        "  ''На мои плечи свалилось много обязательств: если бы меня случайно не оказалось рядом, одному Богу ведомо, что бы произошло.''",
        "  ''Меня глубоко трогают человеческое благородство и умение сохранять «приличие во время стресса».''"
    ],
    2: [
        "  ''Моя искренняя забота об окружающих позволяет мне быть вовлеченным в их дела - знать об их надеждах, мечтах и нуждах.''",
        "  ''Мне кажется естественным быть дружелюбным: я легко завязываю разговор, и я на «ты» практически с каждым''",
        "  ''Я понял, что люди тепло отвечают мне, если я уделяю им внимание и поощряю их.''",
        "  ''Я не могу смотреть на бездомную собаку - я хочу принести ее домой.''",
        "  ''Мне нравится, что я чуткий, великодушный человек.''",
        "  ''Я бы не смог брать плату за то хорошее, что делаю для людей, но меня сильно удручает, когда они не замечают этого или им все равно.''",
        "  ''Это правда, что я часто делаю для людей больше, чем мог бы, - я слишком отдаюсь этому, совсем не думая о себе.''",
        "  ''Я часто ловлю себя на мысли, что пытаюсь завоевать людей, — особенно если вначале они были ко мне безразличны.''",
        "  ''Мне особенно приятно развлекать и принимать у себя моих друзей и родственников.''",
        "  ''Я могу быть теплым и оказывать поддержку, но я гораздо более жесткий, чем могут подумать окружающие.''",
        "  ''Я в состоянии выражать свои чувства более открыто, чем многие.''",
        "  ''Я предпринимаю особые усилия для того, чтобы узнать, что происходит с людьми, которые мне небезразличны.''",
        "  ''Я считаю себя чем-то вроде «доктора разбитых сердец».''",
        "  ''Мое здоровье и финансовое положение часто страдают, так как для меня нужды и интересы окружающих важнее, чем мои собственные.''",
        "  ''Мне нравится преодолевать себя для того, чтобы люди ощущали себя со мной желанными и оцененными по до-стоинству.''"
    ],
    3: [
        "  ''Я считаю себя высококомпетентным человеком: меня действительно беспокоит, когда я неэффективен и неквалифицирован.''",
        "  ''Когда все вокруг меня хорошо, я поистине «свечусь» от внутренней радости - от того, кто я есть, и от той жизни, какую я имею.''",
        "  ''Я стараюсь показать себя людям в самом лучшем свете - а разве не все так делают?''",
        "  ''Мне несвойственно разрываться чувствами - сильные чувства возникают у меня лишь ненадолго, но потом я просто-напросто принимаюсь за работу.''",
        "  ''Для меня важно чувствовать себя успешным, несмотря на то что я еще не достиг того уровня успеха, к которому стремлюсь.''",
        "  ''Плохо это или хорошо, я хорошо скрываю свои страхи - люди никогда не угадают, что я действительно чувствую.''",
        "  ''Я хочу производить хорошее впечатление на людей, поэтому я обычно вежлив, обладаю хорошими манерами и дружелюбен.''",
        "  ''Я знаю, как дела у моих друзей и коллег, и обычно сравниваю себя с ними.''",
        "  ''Я часто стараюсь быть лучшим в том, что я делаю, и если я не могу в чем-то достичь ошеломляющего успеха, то за это даже не берусь.''",
        "  ''Иногда мне приходилось «срезать углы» для того, чтобы достичь моих целей.''",
        "  ''Когда я чувствую себя неуверенно, я могу быть с людьми достаточно безучастным и холодным.''",
        "  ''Меня действительно беспокоит, когда окружающие не признают то, что я превосходно что-то сделал.''",
        "  ''Я более «приспосабливаемый» к обстоятельствам жизни, чем многие: если что-то не происходит так, как хотелось бы, я знаю, как изменить мое поведение для того, чтобы достичь желаемых результатов.''",
        "  ''У меня всегда есть цель, и я знаю, как мотивировать себя, чтобы ее достичь.''",
        "  ''Я считаю себя трудоголиком — я чувствую себя неустойчиво, если не довожу дело до конца.''"
    ],
    4: [
        "  ''Многие видят во мне загадочную, сложную и противоречивую личность — и мне это в себе нравится.''",
        "  ''Я часто размышляю над моими негативными чувствами долгое время до того, как мне удастся от них избавиться.''",
        "  ''Я часто чувствую себя одиноким, даже когда нахожусь с близкими мне людьми.''",
        "  ''Если меня критикуют или не понимают, то я обычно удаляюсь и становлюсь мрачным (дуюсь).''",
        "  ''Мне сложно заниматься проектами, в которых нет твор-ческого элемента.''",
        "  ''Мне не нравится следовать правилам или ожиданиям, так как я должен привнести что-то особенное в то, что я делаю.''",
        "  ''По большому счегу, я достаточно драматичен и темпераментен.''",
        "  ''Я много размышляю о воображаемых сценах и разговорах, даже тех, которых могло и не быть.''",
        "  ''Я очень сильно хочу, чтобы кто-то спас меня и избавил от всего этого ужаса.''",
        "  ''Когда вокруг складываются сложные обстоятельства, я обычно опускаю руки и сдаюсь - даже можно сказать, что сдаюсь слишком легко.''",
        "  ''Я могу простить практически все, кроме плохого вкуса.''",
        "  ''Честно говоря, в целом я не люблю очень тесно с кем-то работать.''",
        "  ''Найти себя и быть верным своим эмоциональным нуждам - все это является чрезвычайно важным для меня.''",
        "  ''Мне не нравится быть ни лидером, ни последователем.''",
        "  ''У меня очень тонкая интуиция, несмотря на то что я не всегда имею смелость сделать так, как она мне подсказывает.''",

    ],

    5: [

        "  ''Я люблю досконально изучать вещи и вдаюсь в детали до тех пор, пока не выясню все как можно более полно.''",
        "  ''Я являюсь чрезвычайно закрытым человеком и не пускаю большое количество людей в мой мир.''",
        "  ''Я не чувствую себя очень большим и властным - скорее маленьким и невидимым. Из меня бы получился хороший шпион.''",
        "  ''Окружающие посчитали бы меня сумасшедшим, если бы узнали, о чем я почти все время думаю.''",
        "  ''Рациональное решение можно принять только тогда, когда ты собрал точную информацию, но тогда большинство людей не являются рациональными.''",
        "  ''Моя семья считает меня в некоторой степени странным или эксцентричным - по крайней мере, они говорят, что мне необходимо больше общаться.''",
        "  ''Я могу говорить без остановки, когда захочу, но в основном предпочитаю лишь наблюдать за тем сумасшествем, что происходит вокруг меня.''",
        "  ''Если вам необходимо, чтобы проблема была решена, позвольте мне самому над ней поработать, и я вернусь к вам с ответом.''",
        "  ''Если вы действительно над этим задумаетесь, то поймете то, что вы называете «нормальным» поведением, является по сути очень странным.''",
        "  ''Я обычно трачу много времени на так называемую «тонкую настройку» проектов, над которыми работаю.''",
        "  ''Большинство людей настолько невежественны, что удивительно, как все вообще работает!''",
        "  ''Я знаю много, но в некоторых областях считаю себя экспертом.''",
        "  ''Я чрезмерно любопытен, и мне нравится выяснять, почему все так, как оно есть, — даже очевидные вещи оказываются не такими очевидными, если их внимательно изучить.''",
        "  ''Мой мозг такой напряженный и активный, что я часто чувствую, как он вскипает.''",
        "  ''Иногда я теряю чувство времени, потому что сильно концентрируюсь на том, что делаю.''",
    ],

    6: [

        "  ''Меня притягивает авторитетное мнение, но я одновременно не доверяю ему.''",
        "  ''Я очень эмоционален, хотя чаще всего не показываю того, что чувствую, никому, кроме близких, но даже и им не всегда.''",
        "  ''Если я делаю ошибку, то боюсь, что сейчас каждый «разорвет меня на куски».''",
        "  ''Я чувствую себя более безопасно, делая то, чего от меня ожидают, чем изобретая что-то свое.''",
        "  ''Я не всегда могу соглашаться с правилами, даже не всегда им следовать, но я должен их знать!''",
        "  ''У меня складывается довольно сильное первое впечатление о людях, и это впечатление меняется с трудом.''",
        "  ''Есть несколько человек, которых я действительно уважаю, — они для меня что-то вроде «моих героев».''",
        "  ''Я не люблю принимать серьезные решения, но также, безусловно, не хочу, чтобы кто-либо принимал их вместо меня!''",
        "  ''Некоторые считают меня неспокойным и нервным, но они не знают даже толики того, что во мне происходит!''",
        "  ''Я знаю, что могу все перепутать, и поэтому нет ничего странного в том, что я очень сильно подозреваю в этом же других людей.''",
        "  ''Я хочу доверять людям, но очень часто задаю себе вопросы по поводу их действительных мотивов.''",
        "  ''Я действительно много работаю - не остановлюсь, пока работа не будет сделана.''",
        "  ''Я сначала выясняю мнение людей, которым доверяю, а потом принимаю серьезное решение.''",
        "  ''Действительно странно: я бываю настроен скептически, даже цинично по поводу всего, а потом разворачиваюсь и попадаю на крючок.''",
        "  ''«Беспокойство» - это мое второе имя.''",
    ],

    7: [

        "  ''Я люблю путешествовать и пробовать различные виды пищи, узнавать разных людей и получать впечатления - целый ураган жизни!''",
        "  ''Мой календарь обычно заполнен, и мне это нравится: под моими ногами и трава не вырастет!''",
        "  ''То, что мне важно, - это возбуждение и разнообразие, а не комфорт и уют, хотя я не против комфорта там, где я его могу найти.''",
        "  ''Мой ум постоянно болтает - иногда мне кажется, что я думаю о десяти вещах одновременно!''",
        "  ''То, что я однозначно не могу терпеть, так это скуку - и я постоянно стараюсь сам не быть скучным.''",
        "  ''Когда я имею с кем-то отношения, то я достаточно им предан, но когда все закончено — я иду дальше, оставляя их в прошлом.''",
        "  ''Я любопытен и люблю приключения, я обычно первым среди моих друзей пробую что-то новое и интересное.''",
        "  ''Когда мне что-то прекращает нравиться, я перестаю это делать.''",
        "  ''Я не то чтобы просто «весельчак» — во мне есть серьезная, даже темная, сторона, хотя мне не сильно хочется туда ходить.''",
        "  ''Я хорошо вижу «большую картину», но отнюдь не мелкие детали: мне доставляет большее удовольствие стра-тегически обдумывать много новых идей, а не вовлекаться в их детальную проработку.''",
        "  ''Если я действительно чего-то хочу, нахожу способ это получить.''",
        "  ''Вещи нервируют меня время от времени, но я быстро восстанавливаюсь.''",
        "  ''Одной из моих проблем является то, что я легко отвлекаюсь и могу «разбрасываться».''",
        "  ''Я имею тенденцию тратить больше денег, чем бы следовало.''",
        "  ''Когда рядом другие люди — это здорово, если, конечно, они хотят пойти туда, куда иду я.''",
    ],

    8: [

        "  ''Я чрезвычайно независим и не люблю зависеть от других, чтобы получить то, что мне действительно необходимо.''",
        "  ''Я понимаю, что «если хочешь сделать яичницу, придется разбить несколько яиц».''",
        "  ''Когда я забочусь о людях, я часто думаю о них как о «своих людях», и мне кажется, что мне нужно думать об их интересах.''",
        "  ''Я знаю, как достичь результатов, я знаю, как вознаградить людей и как надавить на них для того, чтобы все было сделано.''",
        "  ''Я не испытываю особой симпатии к тем, кто слаб и нереши-телен, - слабость притягивает проблемы.''",
        "  ''У меня сильная воля, и я быстро не сдаюсь.''",
        "  ''Я испытываю огромную гордость, когда те, кого я взял под свое крыло, крепко встают на ноги.''",
        "  ''Во мне есть нежная, даже сентиментальная сторона, но я показываю ее далеко не всем.''",
        "  ''Люди, которые меня знают, ценят во мне то, что я всегда говорю прямо то, что действительно думаю.''",
        "  ''Я очень много работал для того, чтобы получить то, что имею. Я считаю, что борьба - это хорошо, потому что она закаляет и помогает ясно понять, что ты хочешь.''",
        "  ''Я расцениваю себя как человека, бросающего «вызов», как кого-то, кто выталкивает людей из зоны комфорта для того, чтобы они добились наилучшего результата.''",
        "  ''Мое чувство юмора приземленное, иногда даже грубое, хотя я думаю, что большинство людей слишком жеманны и тонкокожи.''",
        "  ''У меня бывают вспышки ярости, но они прекращаются.''",
        "  ''Я чувствую себя наиболее в тонусе, когда делаю вещи, которые другие считают невозможными. Мне нравится «ходить по краю» и смотреть, удастся ли мне добиться успеха, несмотря ни на что.''",
        "  ''Кто-то обычно должен быть виноватым, но мне не хотелось бы, чтобы это был я.''",

    ],

    9: [
        "  ''Людям нравится во мне то, что со мной они чувствуют себя в безопасности.''",
        "  ''Я без проблем могу находиться в компании людей, я без проблем могу находиться один - любой вариант ОК, пока я нахожусь в мире с собой.''",
        "  ''Я нашел определенный баланс в моей жизни и не вижу причины его нарушать.''",
        "  ''Чувствовать себя комфортно в любом смысле этого слова - это то, что мне очень нравится.''",
        "  ''Я лучше уступлю кому-нибудь, чем буду устраивать сцены.''",
        "  ''Я точно не знаю, как у меня это получается, но я не позволяю обстоятельствам меня задевать.''",
        "  ''Мне очень легко доставить удовольствие, и у меня такое ощущение, что все, что я имею, вполне хорошо для меня.''",
        "  ''Мне говорили, что я кажусь отсутствующим, - на самом деле я все понимаю, но просто не хочу реагировать.''",
        "  ''Я не думаю, что отличаюсь особым упрямством, но люди говорят, что я могу быть очень несговорчивым, как только я сформировал свою точку зрения.''",
        "  ''Многие люди очень легко выходят из себя: я же более уравновешенный.''",
        "  ''еобходимо принимать жизнь такой, какая она есть, так как мало что мы можем изменить.''",
        "  ''Я могу легко понимать различные точки зрения и намного чаще соглашаюсь с людьми, чем не соглашаюсь.''",
        "  ''Я верю в то, что в жизни лучше концентрироваться на по-зитивном, чем думать о негативном.''",
        "  ''У меня есть так называемая «философия жизни», которая является моим путеводителем и выручает меня в трудную минуту.''",
        "  ''В течение дня я делаю то, что необходимо сделать, но, когда день завершен, я знаю, как расслабиться и отвлечься от неприятностей.''",
    ]
}

# Временное хранилище ответов пользователей
user_data_store = {}


# Кнопки выбора типа личности
def type_keyboard():
    keyboard = []
    for row in range(3):
        keyboard.append(
            [InlineKeyboardButton(str(i), callback_data=f"type_{i}") for i in range(1 + row * 3, 4 + row * 3)])
    return InlineKeyboardMarkup(keyboard)


# Кнопки ответов от 1 до 5
def answer_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton(str(i), callback_data=str(i)) for i in range(1, 6)]
    ])


# Кнопка "Пройти тест заново"
def restart_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("Пройти тест заново", callback_data="restart")]
    ])


# Команда /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Привет! Выберите тип личности от 1 до 9: \n\n"
                                    " 1 - Реформатор\n"
                                    " 2 - Помощник\n"
                                    " 3 - Стремящийся к успеху\n"
                                    " 4 - Индивидкалист\n"
                                    " 5 - Мыслитель\n"
                                    " 6 - Лоялист\n"
                                    " 7 - Энтузиаст\n"
                                    " 8 - Конфронтатор\n"
                                    " 9 - Миротворец\n\n"

                                    "Инструкция к ответам:\n\n"
                                    "Выберите вариант ответа от 1 до 5:\n"
                                    "1 - Совсем неверное\n"
                                    "2 - Иногда верно\n"
                                    "3 - В какой-то мере верно\n"
                                    "4 - В основном верно\n"
                                    "5 - Совершенно верно"
                                    , reply_markup=type_keyboard())

    return CHOOSE_TYPE


# Обработка выбора типа личности
async def handle_type_choice(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data

    if data.startswith("type_"):
        ptype = int(data.split("_")[1])
        user_id = query.from_user.id

        user_data_store[user_id] = {
            "type": ptype,
            "current_question": 0,
            "answers": []
        }

        first_question = PERSONALITY_TESTS[ptype][0]
        await query.message.reply_text(first_question, reply_markup=answer_keyboard())
        return ASK_QUESTION


# Обработка ответов на вопросы
async def handle_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id

    user_data = user_data_store.get(user_id)
    if not user_data:
        await query.message.reply_text("Что-то пошло не так. Начните заново с /start.")
        return ConversationHandler.END

    try:
        answer = int(query.data)
        user_data['answers'].append(answer)
        user_data['current_question'] += 1

        if user_data['current_question'] < 15:
            next_q = PERSONALITY_TESTS[user_data['type']][user_data['current_question']]
            await query.message.reply_text(next_q, reply_markup=answer_keyboard())
            return ASK_QUESTION
        else:
            total = sum(user_data['answers'])
            await query.message.reply_text(
                f"Вы завершили тест!\nСумма ваших баллов: {total}",
                reply_markup=restart_keyboard()
            )
            # Возвращаемся в CHOOSE_TYPE, чтобы можно было пройти тест заново
            return CHOOSE_TYPE

    except Exception:
        await query.message.reply_text("Ошибка. Попробуйте снова.")
        return ConversationHandler.END


# Обработка кнопки "Пройти тест заново"
async def restart(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id
    # Очищаем данные пользователя
    user_data_store.pop(user_id, None)
    # Предлагаем выбрать тип заново
    await query.message.reply_text("Привет! Выберите тип личности от 1 до 9: \n\n"
                                   " 1 - Реформатор\n"
                                   " 2 - Помощник\n"
                                   " 3 - Стремящийся к успеху\n"
                                   " 4 - Индивидкалист\n"
                                   " 5 - Мыслитель\n"
                                   " 6 - Лоялист\n"
                                   " 7 - Энтузиаст\n"
                                   " 8 - Конфронтатор\n"
                                   " 9 - Миротворец", reply_markup=type_keyboard())
    return CHOOSE_TYPE


# Отмена теста
async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Тест отменён.")
    return ConversationHandler.END


def main():
    app = ApplicationBuilder().token("7665783164:AAGD1T8h0Kh5l6haarN3b0Zt6MQLQ1E3jMk").build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler('start', start)],
        states={
            CHOOSE_TYPE: [
                CallbackQueryHandler(handle_type_choice, pattern="^type_\\d$"),
                CallbackQueryHandler(restart, pattern="^restart$")
            ],
            ASK_QUESTION: [CallbackQueryHandler(handle_answer, pattern="^[1-5]$")]
        },
        fallbacks=[CommandHandler("cancel", cancel)]
    )

    app.add_handler(conv_handler)
    print("Бот запущен...")
    app.run_polling()


if __name__ == '__main__':
    main()

